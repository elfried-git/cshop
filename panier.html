<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon panier</title>
  <link rel="stylesheet" href="global.css">
  <link rel="stylesheet" href="panier.css">
  <style>
    .valider-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
</head>

<body>

  <header class="main-header">
    <div id="logo">
      <a href="index.html">
        <img src="images/assoc.png" alt="Logo de l'association">
      </a>
    </div>
    
    <!-- Menu burger pour mobile -->
    <button class="menu-burger" id="menu-burger" aria-label="Ouvrir le menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    
    <nav class="main-nav" id="main-nav" aria-label="Menu principal">
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="quisommesnous.html">Qui sommes-nous ?</a></li>
        <li><a href="index.html#produits-en-avant">Produits</a></li>
        <li><a href="index.html#categories-en-avant">Catégories</a></li>
        <li><a href="index.html#contact">Contact</a></li>
        <li><a href="connexion.html">Profil</a></li>
        <li>
          <a href="panier.html" class="icone-panier" aria-label="Voir le panier">
            <img src="images/panier.png" alt="Panier" />
            <span id="compteur-panier">0</span>
          </a>
        </li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="panier-container">
      <h1>Mon panier</h1>

      <div class="panier-table-container">
        <table class="panier-table">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Nom</th>
              <th>Prix</th>
              <th>Quantité</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="panier-body">
          </tbody>
        </table>
      </div>

      <div class="resume-panier">
        <p><strong>Total panier :</strong> <span id="total-panier">0 €</span></p>

        <div class="boutons-panier">
          <a href="index.html" class="btn btn-secondary">Continuer mes achats</a>
          <button class="btn valider-btn" id="valider-btn" disabled>Valider ma commande</button>
        </div>
      </div>
    </section>
  </main>



  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById("panier-body");
      const totalPanier = document.getElementById("total-panier");
      // MODIFICATION : On récupère le bouton de validation
      const boutonValider = document.getElementById("valider-btn");

      function afficherPanier() {
        const panier = JSON.parse(localStorage.getItem("panier")) || [];
        // Récupérer la devise sauvegardée depuis la page d'accueil
        const selectedCurrency = sessionStorage.getItem('selectedCountry') || 'EUR';
        tbody.innerHTML = "";
        let total = 0;

        if (panier.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "Votre panier est vide.";
          td.style.textAlign = "center";
          tr.appendChild(td);
          tbody.appendChild(tr);
          // MODIFICATION : On s'assure que le bouton est bien désactivé
          boutonValider.disabled = true;
        } else {
          // MODIFICATION : Si le panier n'est pas vide, on active le bouton
          boutonValider.disabled = false;

          panier.forEach((item, index) => {
            const tr = document.createElement("tr");
            tr.setAttribute("data-index", index);

            // Conversion des prix selon la devise sauvegardée
            const prixConverti = convertirPrix(item.prix, selectedCurrency);
            const totalItem = convertirPrix(item.prix * item.quantite, selectedCurrency);
            total += item.prix * item.quantite; // Garder le total en EUR pour les calculs

            tr.innerHTML = `
              <td><img src="${item.image}" alt="${item.nom}"></td>
              <td>${item.nom}</td>
              <td>${prixConverti}</td>
              <td><input type="number" class="quantite-input" value="${item.quantite}" min="1" data-index="${index}"></td>
              <td>${totalItem}</td>
              <td><button class="remove-btn" data-index="${index}">Supprimer</button></td>
            `;

            tbody.appendChild(tr);
          });
        }

        // Afficher le total converti
        const totalConverti = convertirPrix(total, selectedCurrency);
        totalPanier.textContent = totalConverti;
        activerSuppression();
        activerQuantite();
      }

      function activerSuppression() {
        const boutons = document.querySelectorAll(".remove-btn");
        boutons.forEach(bouton => {
          bouton.addEventListener("click", function () {
            const index = parseInt(this.getAttribute("data-index"));
            let panier = JSON.parse(localStorage.getItem("panier")) || [];
            panier.splice(index, 1);
            localStorage.setItem("panier", JSON.stringify(panier));
            afficherPanier();
            updateCartCounter();
          });
        });
      }

      function activerQuantite() {
        const inputs = document.querySelectorAll(".quantite-input");
        inputs.forEach(input => {
          input.addEventListener("change", function () {
            const index = parseInt(this.getAttribute("data-index"));
            let panier = JSON.parse(localStorage.getItem("panier")) || [];
            panier[index].quantite = parseInt(this.value);
            localStorage.setItem("panier", JSON.stringify(panier));
            afficherPanier();
            updateCartCounter();
          });
        });
      }

      // MODIFICATION : On ajoute l'événement 'click' au bouton ici
      boutonValider.addEventListener("click", ouvrirPaiement);

      afficherPanier();
    });
  </script>

  <script>
    function ouvrirPaiement() {
      // Cette fonction ne s'exécutera que si le bouton n'est pas désactivé
      window.location.href = "paiement.html";
    }
  </script>

  <script>
    function updateCartCounter() {
      const compteur = document.getElementById("compteur-panier");
      if (compteur) {
        const panier = JSON.parse(localStorage.getItem("panier")) || [];
        const totalArticles = panier.reduce((acc, item) => acc + item.quantite, 0);
        compteur.textContent = totalArticles;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateCartCounter();
    });
  </script>

  <!-- Script pour la conversion de devise -->
  <script>
    // Taux de conversion (Base : 1 EUR)
    const TAUX_FCFA = 655.957;
    const TAUX_USD = 1.07;

    /**
     * Convertit un prix en EUR vers la devise sélectionnée
     * @param {number} prixEur - Le prix en euros
     * @param {string} currency - La devise cible ('EUR', 'XAF' ou 'USD')
     * @returns {string} - Le prix formaté avec le symbole de la devise
     */
    function convertirPrix(prixEur, currency) {
      let newPrice;
      let currencySymbol;
      let locale = 'fr-FR';

      if (currency === 'XAF') {
        // Conversion en FCFA
        newPrice = Math.round(prixEur * TAUX_FCFA / 1000) * 1000;
        currencySymbol = ' FCFA';
        newPrice = newPrice.toLocaleString(locale);
      } else if (currency === 'USD') {
        // Conversion en USD
        newPrice = (prixEur * TAUX_USD).toFixed(2);
        currencySymbol = ' $';
        locale = 'en-US';
      } else {
        // Euro (EUR)
        newPrice = prixEur.toFixed(2);
        currencySymbol = '€';
        newPrice = newPrice.replace('.00', ''); // Enlève .00 si c'est un prix entier
      }

      return `${newPrice}${currencySymbol}`;
    }

    // Pas besoin de script supplémentaire, la devise est automatiquement récupérée depuis sessionStorage
  </script>

  <!-- Script pour le menu burger mobile -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const menuBurger = document.getElementById("menu-burger");
      const mainNav = document.getElementById("main-nav");

      if (menuBurger && mainNav) {
        menuBurger.addEventListener("click", () => {
          mainNav.classList.toggle("nav-open");
          menuBurger.classList.toggle("menu-open");
        });

        // Fermer le menu quand on clique sur un lien
        const navLinks = mainNav.querySelectorAll("a");
        navLinks.forEach(link => {
          link.addEventListener("click", () => {
            mainNav.classList.remove("nav-open");
            menuBurger.classList.remove("menu-open");
          });
        });

        // Fermer le menu quand on clique en dehors
        document.addEventListener("click", (e) => {
          if (!mainNav.contains(e.target) && !menuBurger.contains(e.target)) {
            mainNav.classList.remove("nav-open");
            menuBurger.classList.remove("menu-open");
          }
        });
      }
    });
  </script>
</body>

</html>